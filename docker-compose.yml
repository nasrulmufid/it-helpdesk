version: '3.8'

services:
  app:
    build: .
    image: nasrulmufid/it-help-desk:latest
    container_name: it-help-desk-app
    ports:
      - "${APP_PORT:-8010}:80"
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_KEY: ${APP_KEY:-}
      DB_CONNECTION: mysql
      DB_HOST: db
      DB_PORT: 3306
      DB_DATABASE: ${MYSQL_DATABASE:-it_helpdesk}
      DB_USERNAME: ${MYSQL_USER:-it_helpdesk_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-it_helpdesk_pass}
    volumes:
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
    networks:
      - it-helpdesk-public
      - it-helpdesk-internal
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/" ]
      timeout: 10s
      retries: 3
      interval: 10s
      start_period: 30s

  db:
    image: mysql:8.0
    container_name: it-help-desk-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-it_helpdesk}
      MYSQL_USER: ${MYSQL_USER:-it_helpdesk_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-it_helpdesk_pass}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - it-helpdesk-internal
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$$MYSQL_ROOT_PASSWORD"]
      timeout: 5s
      retries: 5
      interval: 10s

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: it-help-desk-phpmyadmin
    restart: unless-stopped
    ports:
      - "${PHPMYADMIN_PORT:-8081}:80"
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
      PMA_USER: ${MYSQL_USER:-it_helpdesk_user}
      PMA_PASSWORD: ${MYSQL_PASSWORD:-it_helpdesk_pass}
      PMA_ARBITRARY: 0
    depends_on:
      db:
        condition: service_healthy
    networks:
      - it-helpdesk-public
      - it-helpdesk-internal

networks:
  it-helpdesk-public:
    driver: bridge
  it-helpdesk-internal:
    driver: bridge
    internal: true

volumes:
  mysql_data:
